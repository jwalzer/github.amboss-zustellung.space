<!doctype html><html lang="en"
  >
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Deep Linking images from foreign domains - Amboss-incoming</title><link rel="apple-touch-icon" href="https://github.amboss-zustellung.space/images/favicons/apple-touch-icon.png" sizes="180x180">
<link rel="icon" href="https://github.amboss-zustellung.space/images/favicons/favicon-32x32.png" sizes="32x32" type="image/png">
<link rel="icon" href="https://github.amboss-zustellung.space/images/favicons/favicon-16x16.png" sizes="16x16" type="image/png">
<link rel="manifest" href="https://github.amboss-zustellung.space/images/favicons/manifest.json">
<link rel="icon" href="https://github.amboss-zustellung.space/images/favicons/favicon.ico">
<meta name="keywords" content="" />
<meta name="description" content="" /><meta itemprop="name" content="Deep Linking images from foreign domains">
<meta itemprop="description" content="Deep Linking images from foreign domains  The theory The Webserver The Script   Last week I found in my webstatistics, that I had some spike in the traffic.
A foreign weblog or forum in hungarian language had one of the pictures on my site linked directly into their comments.
I have no Problems with people using my pictures on their Website, even less if its not a workfrom me, but from someone else, and I also only have a copy.
But what buggs me, is that other ones are reading forums and are seeing images on a foreign website and noone notices, that the image is delivered from my webserver, while on the other hand, my connection is filled up with 3000 requests in 2hours.
The theory To limit this behaviour for the next time, I did some configuration of the webserver(lighttpd) and some php-scripting.
In future I&rsquo;ll decide for every request to an image if the referrer is either empty or from my website (at least lzer.net). If thats the case, then normally either someone is reading my site, or he got a direct link to an article or an image. Thats fine with me. But if an image is embedded from another website, then the browser must have send (at least in 95% of the cases, geeks don&rsquo;t count) an referrer thats completely different.
In this case I&rsquo;ll be redirecting them to another version of the image that will have the prefix &lsquo;/img/cached&rsquo; in front of the original image path.">
<meta itemprop="dateModified" content="2021-10-29T01:37:00+02:00" />
<meta itemprop="wordCount" content="1118">
<meta itemprop="keywords" content="script,php,lighttpd,webserver,image,generate,blog," /><meta property="og:title" content="Deep Linking images from foreign domains" />
<meta property="og:description" content="Deep Linking images from foreign domains  The theory The Webserver The Script   Last week I found in my webstatistics, that I had some spike in the traffic.
A foreign weblog or forum in hungarian language had one of the pictures on my site linked directly into their comments.
I have no Problems with people using my pictures on their Website, even less if its not a workfrom me, but from someone else, and I also only have a copy.
But what buggs me, is that other ones are reading forums and are seeing images on a foreign website and noone notices, that the image is delivered from my webserver, while on the other hand, my connection is filled up with 3000 requests in 2hours.
The theory To limit this behaviour for the next time, I did some configuration of the webserver(lighttpd) and some php-scripting.
In future I&rsquo;ll decide for every request to an image if the referrer is either empty or from my website (at least lzer.net). If thats the case, then normally either someone is reading my site, or he got a direct link to an article or an image. Thats fine with me. But if an image is embedded from another website, then the browser must have send (at least in 95% of the cases, geeks don&rsquo;t count) an referrer thats completely different.
In this case I&rsquo;ll be redirecting them to another version of the image that will have the prefix &lsquo;/img/cached&rsquo; in front of the original image path." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://github.amboss-zustellung.space/posts/deep-linking_images_from_foreign_domains/" /><meta property="article:section" content="posts" />

<meta property="article:modified_time" content="2021-10-29T01:37:00+02:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Deep Linking images from foreign domains"/>
<meta name="twitter:description" content="Deep Linking images from foreign domains  The theory The Webserver The Script   Last week I found in my webstatistics, that I had some spike in the traffic.
A foreign weblog or forum in hungarian language had one of the pictures on my site linked directly into their comments.
I have no Problems with people using my pictures on their Website, even less if its not a workfrom me, but from someone else, and I also only have a copy.
But what buggs me, is that other ones are reading forums and are seeing images on a foreign website and noone notices, that the image is delivered from my webserver, while on the other hand, my connection is filled up with 3000 requests in 2hours.
The theory To limit this behaviour for the next time, I did some configuration of the webserver(lighttpd) and some php-scripting.
In future I&rsquo;ll decide for every request to an image if the referrer is either empty or from my website (at least lzer.net). If thats the case, then normally either someone is reading my site, or he got a direct link to an article or an image. Thats fine with me. But if an image is embedded from another website, then the browser must have send (at least in 95% of the cases, geeks don&rsquo;t count) an referrer thats completely different.
In this case I&rsquo;ll be redirecting them to another version of the image that will have the prefix &lsquo;/img/cached&rsquo; in front of the original image path."/>
<meta name="twitter:site" content="@janwalzer"/>
<link rel="preload" href="https://github.amboss-zustellung.space/css/bundle.min.56f818f19e58c97481c8333650e24bf131abfada62c954646a72ae940adb3bf5.css" integrity="sha256-VvgY8Z5YyXSByDM2UOJL8TGr&#43;tpiyVRkanKulArbO/U=" crossorigin="anonymous" as="style" onload="this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://github.amboss-zustellung.space/css/bundle.min.56f818f19e58c97481c8333650e24bf131abfada62c954646a72ae940adb3bf5.css" integrity="sha256-VvgY8Z5YyXSByDM2UOJL8TGr&#43;tpiyVRkanKulArbO/U=" crossorigin="anonymous"></noscript></head>
  <body><script src="https://github.amboss-zustellung.space/js/bootstrap.min.b5d86dd3a5f60c90be38a252bb65fc1a2732f32e71dc12c051720f0c7aef3cde.js" integrity="sha256-tdht06X2DJC&#43;OKJSu2X8Gicy8y5x3BLAUXIPDHrvPN4=" crossorigin="anonymous"></script><header><nav class="navbar top-app-bar top-app-bar-expand-lg fixed-top">
  <div class="container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
      aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <i class="fas fa-bars"></i>
    </button><a class="navbar-brand me-3" href="https://github.amboss-zustellung.space/"><img class="logo" alt="Logo" src="" loading="lazy"
  
   />
Amboss-incoming
    </a>
    <button class="navbar-social-share" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSocialShare"
  aria-controls="offcanvasSocialShare" aria-label="Toggle social share">
  <i class="fas fa-share-alt"></i>
</button>

<div class="offcanvas offcanvas-bottom surface" tabindex="-1" id="offcanvasSocialShare" aria-labelledby="offcanvasSocialShare">
  <div class="offcanvas-header">
    <h3 class="offcanvas-title">Share</h3>
    <button type="button" class="btn btn-sm btn-outline-primary" data-bs-dismiss="offcanvas" aria-label="Close">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div class="offcanvas-body">
    <a class="btn btn-sm btn-outline-primary social-share-button" rel="noopener noreferrer" aria-label="Twitter Share Button"
      target="_blank" href="https://twitter.com/intent/tweet?title=Deep%20Linking%20images%20from%20foreign%20domains&url=https%3a%2f%2fgithub.amboss-zustellung.space%2fposts%2fdeep-linking_images_from_foreign_domains%2f">
      <i class="fab fa-fw fa-twitter"></i> Twitter
    </a>
    <a class="btn btn-sm btn-outline-primary social-share-button" rel="noopener noreferrer" aria-label="Facebook Share Button"
      target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fgithub.amboss-zustellung.space%2fposts%2fdeep-linking_images_from_foreign_domains%2f">
      <i class="fab fa-fw fa-facebook-f"></i> Facebook
    </a>
  </div>
</div>

    <button class="navbar-settings" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSettings"
  aria-controls="offcanvasSettings" aria-label="Toggle settings">
  <i class="fas fa-ellipsis-v"></i>
</button>

<div class="offcanvas offcanvas-end surface h-100" tabindex="-1" id="offcanvasSettings" aria-labelledby="offcanvasSettings">
  <div class="offcanvas-header">
    <h3 class="offcanvas-title">Settings</h3>
    <button type="button" class="btn btn-sm btn-outline-primary" data-bs-dismiss="offcanvas" aria-label="Close">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div class="offcanvas-body">

<section class="setting">
  <form class="row">
    <div class="col-auto">
      <label><i class="fas fa-fw fa-adjust"></i> Mode</label>
    </div>
    <div class="col-auto ms-auto">
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="modeSwitcher">
      </div>
    </div>
  </form>
</section>


<section class="setting palettes">
  <form class="row">
    <div class="col-auto">
      <label><i class="fas fa-fw fa-palette"></i> Palette</label>
    </div>
    <div class="col-auto ms-auto">
      <a id="btnPalette" class="btn btn-sm btn-outline-primary" role="button" aria-label="palettePicker">
        <i class="fas fa-eye-dropper"></i>
      </a>
    </div>
  </form>
  <div class="mt-2 d-flex visually-hidden" id="palettePicker"><button type="button" id="palette-blue" aria-label="Blue"
        class="btn btn-sm palette" data-palette="blue">
      </button><button type="button" id="palette-blue-gray" aria-label="Blue Gray"
        class="btn btn-sm palette" data-palette="blue-gray">
      </button><button type="button" id="palette-brown" aria-label="Brown"
        class="btn btn-sm palette" data-palette="brown">
      </button><button type="button" id="palette-cyan" aria-label="Cyan"
        class="btn btn-sm palette" data-palette="cyan">
      </button><button type="button" id="palette-green" aria-label="Green"
        class="btn btn-sm palette" data-palette="green">
      </button><button type="button" id="palette-indigo" aria-label="Indigo"
        class="btn btn-sm palette" data-palette="indigo">
      </button><button type="button" id="palette-orange" aria-label="Orange"
        class="btn btn-sm palette" data-palette="orange">
      </button><button type="button" id="palette-pink" aria-label="Pink"
        class="btn btn-sm palette" data-palette="pink">
      </button><button type="button" id="palette-purple" aria-label="Purple"
        class="btn btn-sm palette" data-palette="purple">
      </button><button type="button" id="palette-red" aria-label="Red"
        class="btn btn-sm palette" data-palette="red">
      </button><button type="button" id="palette-teal" aria-label="Teal"
        class="btn btn-sm palette" data-palette="teal">
      </button><button type="button" id="palette-yellow" aria-label="Yellow"
        class="btn btn-sm palette" data-palette="yellow">
      </button></div>
</section>
</div>
</div>

    <div class="collapse navbar-collapse" tabindex="-1" id="navbarSupportedContent" aria-labelledby="navbarSupportedContent">
      <form class="search-bar my-1" action="https://github.amboss-zustellung.space/search">
  <div class="input-group input-group-sm">
    <span class="btn btn-search disabled position-absolute left-0"><i class="fas fa-fw fa-search"></i></span>
    <input class="form-control rounded-pill" name="q" type="search" aria-label="Search">
  </div>
</form>

      <ul class="navbar-nav ms-auto"><li class="nav-item">
          <a class="nav-link" href="https://github.amboss-zustellung.space/">
            fas fa-homeHome
          </a>
        </li><li class="nav-item">
          <a class="nav-link" href="https://github.amboss-zustellung.space/tags/blog/">
            <i class="fas fa-rss-square"></i>Blog
          </a>
        </li><li class="nav-item">
          <a class="nav-link" href="https://github.amboss-zustellung.space/categories/">
            <i class="fas fa-fw fa-cubes"></i>Categories
          </a>
        </li><li class="nav-item dropdown">
          <a class="nav-link" id="navbarDropdown-posts" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fas fa-fw fa-folder"></i>Posts
          </a>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown-posts"><li>
              <a class="dropdown-item"
                href="https://github.amboss-zustellung.space/categories">
                <i class="fas fa-fw fa-cubes"></i>Categories
              </a>
            </li><li>
              <a class="dropdown-item"
                href="https://github.amboss-zustellung.space/tags">
                <i class="fab fa-fw fa-tags"></i>Tags
              </a>
            </li></ul>
        </li><li class="nav-item dropdown">
          <a class="nav-link" id="navbarDropdown-about" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fas fa-fw fa-user"></i>About
          </a>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown-about"><li>
              <a class="dropdown-item"
                href="https://github.amboss-zustellung.space/contact/">
                <i class="fas fa-fw fa-contact"></i>Contact
              </a>
            </li></ul>
        </li><li class="nav-item">
          <a class="nav-link" href="https://github.com/jwalzer/github.amboss-zustellung.de" target="_blank" rel="noopener noreferrer">
            <i class="fab fa-fw fa-github"></i>Github
          </a>
        </li></ul>
    </div>
  </div>
</nav>
</header>
<main role="main" class="container">
      <div class="row content">
<div class="col-lg-8">
  <div class="container"><nav class="row card component" aria-label="breadcrumb">
  <div class="card-body">
    <ol class="breadcrumb "><li class="breadcrumb-item"><a href="https://github.amboss-zustellung.space/">Home</a></li><li class="breadcrumb-item"><a href="https://github.amboss-zustellung.space/posts/">Posts</a></li><li class="breadcrumb-item active">Deep Linking images from foreign domains</li></ol>
  </div>
</nav>    <article class="row card component mb-4 post"><div class="post-panel-wrapper">
  <div class="d-flex flex-column component rounded post-panel">
    
    <a id="sidebarToggler" class="action d-none d-lg-block" role="button">
  <i class="fas fa-fw fa-expand-alt" data-fa-transform="rotate-45"></i>
</a>
  
    

    
    
    <a class="action" data-bs-toggle="offcanvas" href="#offcanvasTOC" aria-controls="offcanvasTOC" role="button">
  <i class="fas fa-fw fa-list-alt"></i>
</a>
    
  </div>
</div>
<div class="card-body">
        <h1 class="card-title my-3">Deep Linking images from foreign domains
</h1><div class="post-meta"><span class="post-date" title="created on">
    <i class="fas fa-fw fa-calendar-alt"></i>Nov 21, 2010
  </span>
  <span class="post-date me-2" title="updated on">
      <i class="fas fa-sync-alt"></i>
      Oct 29, 2021
    </span>
  <span class="post-reading-time" title="reading time">
    <i class="fas fa-fw fa-coffee"></i>6 min read
  </span><a href="https://github.amboss-zustellung.space/tags/script/" class="badge rounded-pill text-white bg-primary post-taxonomy">script</a><a href="https://github.amboss-zustellung.space/tags/php/" class="badge rounded-pill text-white bg-primary post-taxonomy">php</a><a href="https://github.amboss-zustellung.space/tags/lighttpd/" class="badge rounded-pill text-white bg-primary post-taxonomy">lighttpd</a><a href="https://github.amboss-zustellung.space/tags/webserver/" class="badge rounded-pill text-white bg-primary post-taxonomy">webserver</a><a href="https://github.amboss-zustellung.space/tags/image/" class="badge rounded-pill text-white bg-primary post-taxonomy">image</a><a href="https://github.amboss-zustellung.space/tags/generate/" class="badge rounded-pill text-white bg-primary post-taxonomy">generate</a><a href="https://github.amboss-zustellung.space/tags/blog/" class="badge rounded-pill text-white bg-primary post-taxonomy">blog</a></div>
<div class="offcanvas offcanvas-end surface h-100" tabindex="-1" id="offcanvasTOC" aria-labelledby="offcanvasTOCLabel">
  <div class="offcanvas-header">
    <h2 class="offcanvas-title" id="offcanvasTOCLabel">Table Of Contents</h5>
      <button type="button" class="btn btn-sm btn-outline-primary" data-bs-dismiss="offcanvas" aria-label="Close">
        <i class="fas fa-times"></i>
      </button>
  </div>
  <div class="offcanvas-body">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#the-theory">The theory</a></li>
    <li><a href="#the-webserver">The Webserver</a></li>
    <li><a href="#the-script">The Script</a></li>
  </ul>
</nav>
  </div>
</div><div class="post-content mb-3"><h1 id="deep-linking-images-from-foreign-domains">Deep Linking images from foreign domains</h1>
<nav id="TableOfContents">
  <ul>
    <li><a href="#the-theory">The theory</a></li>
    <li><a href="#the-webserver">The Webserver</a></li>
    <li><a href="#the-script">The Script</a></li>
  </ul>
</nav>

<p>Last week I found in my webstatistics, that I had some spike in the traffic.</p>
<p>A foreign weblog or forum in hungarian language had one of the pictures on my site linked directly into their comments.</p>
<p>I have no Problems with people using my pictures on their Website, even less if its not a workfrom me, but from someone else, and I also only have a copy.</p>
<p>But what buggs me, is that other ones are reading forums and are seeing images on a foreign website and noone notices, that the image is delivered from my webserver, while on the other hand, my connection is filled up with 3000 requests in 2hours.</p>
<h2 id="the-theory">The theory</h2>
<p>To limit this behaviour for the next time, I did some configuration of the webserver(lighttpd) and some php-scripting.</p>
<p>In future I&rsquo;ll decide for every request to an image if the referrer is either empty or from my website (at least <strong>lzer.net</strong>). If thats the case, then normally either someone is reading my site, or he got a direct link to an article or an image. Thats fine with me.
But if  an image is embedded from another website, then the browser must have send (at least in 95% of the cases, geeks don&rsquo;t count) an referrer thats completely different.</p>
<p>In this case I&rsquo;ll be redirecting them to another version of the image that will have the prefix &lsquo;/img/cached&rsquo; in front of the original image path.</p>
<h2 id="the-webserver">The Webserver</h2>
<p>Here is the part of the lighty-config reliable for that:</p>
<pre><code>$HTTP[&quot;url&quot;] =~ &quot;^/wiki/blog/.*\.(gif|png|jpg|jpeg)$&quot; {
    $HTTP[&quot;referer&quot;] !~ &quot;^($|http://.*\.?lzer\.net)&quot; {
        url.redirect += ( &quot;^/(.*)$&quot; =&gt; &quot;/img/cached/$1&quot;  )
        accesslog.filename = &quot;/var/log/lighttpd/suspected_imagetheft.log&quot;
        }
    }
</code></pre>
<p>These images will contain a low-quality version of the original image, and have a text written over the complete image, that the image is linked from my site, and the author should rather copy the image to his site, instead of burning my bandwidth for nothing.</p>
<p>The funny part is, that normally these images don&rsquo;t exist, before they are requested the first time.
They are created by an script that is run on the 404-Handler for this directory:</p>
<pre><code>$HTTP[&quot;url&quot;] =~ &quot;^/img/cached/&quot; {
        server.error-handler-404 = &quot;/imagegenerator/&quot;
        }
</code></pre>
<p>So what&rsquo;s happening there?</p>
<h2 id="the-script">The Script</h2>
<p>I had some time and fun with quick&amp;dirty coding style. Following a commented version of &ldquo;/imaggenerator/index.php&rdquo;:</p>
<pre><code>&lt;?php

$OriginalRequest=$_SERVER[&quot;REQUEST_URI&quot;];

$URIParts=explode('/',$OriginalRequest);
list($EMPTY,$IMG,$CACHED,$RESTURI)=explode('/',$OriginalRequest);
</code></pre>
<p>First we&rsquo;re splitting the original request, and look, if we&rsquo;re really responsible. (Maybe someone directly called the script with a bad intention?)</p>
<pre><code>if ( ('' == $EMPTY) and ('img' == $IMG)  and ('cached' == $CACHED) ) {
</code></pre>
<p>If that&rsquo;s fine, then we&rsquo;re splitting the request and build up the filenames of the original file to load and where the new file will go to</p>
<pre><code>$I=3;
$RealImgFN='/var/www';
$NewImgFN='/var/www/img/cached';
$NewImgDir='/var/www/img/cached';
while($URIParts[$I]!='' ) {
	$RealImgFN.='/'.$URIParts[$I];
	$NewImgFN.='/'.$URIParts[$I];
	if (  !(($NewImgFN[strlen($NewImgFN)-4] == '.' ) or ($NewImgFN[strlen($NewImgFN)-5] == '.' )))	{ $NewImgDir.='/'.$URIParts[$I]; }		
	$I++;
	}
</code></pre>
<p>If we have that, we check for the filetype and load the file for the first time.</p>
<pre><code>switch(strtolower(substr($RealImgFN,-4,4))) {
        case &quot;.jpg&quot; : 
            $im     = imagecreatefromjpeg($RealImgFN);
            break;
        case &quot;.png&quot; : 
            $im     = imagecreatefrompng($RealImgFN);
            imagesavealpha($im,true);
            $is_png=true;
            break;
        case &quot;.gif&quot; : 
            var_dump(&quot;GIF&quot;);
            $im     = imagecreatefromgif($RealImgFN);
            break;
	}		
if (strtolower(substr($RealImgFN,-5,5))==&quot;.jpeg&quot;) {
	$im= imagecreatefromjpeg($RealImgFN);
	}
</code></pre>
<p>If it&rsquo;s an PNG-File, we remember that.  At least we should now have &ldquo;$im&rdquo; loaded. If thats not the case, then we redirect to a generic image (look down)</p>
<pre><code>if ($im) {
        @mkdir($NewImgDir,0777,true);			
</code></pre>
<p>Why mode 0777 ? Because the umask will take care of the maximal rights on my webserver. You would have to check for that yourself.
if (!is_png) {
imagejpeg($im,$NewImgFN.&quot;.tmp.jpg&quot;,5);
$im=imagecreatefromjpeg($NewImgFN.&quot;.tmp.jpg&quot;);
}</p>
<p>But here&rsquo;s the fun part: If it&rsquo;s not an PNG (Which will probably have Alpha(Transparency)-Information in it, which get lost on JPEG-Compression) then we first write it out as an temp-image with JPEG-Compression 5 (Which is VERY LOW quality) and reopen it.</p>
<p>Then we prepare for the text to write into the image.</p>
<pre><code>        $string1	= &quot;Image linked to http://wa.lzer.net&quot;;
        $fontfile='/usr/share/fonts/truetype/ttf-dejavu/DejaVuSans-Bold.ttf';
        $blue = imagecolorallocate($im, 64, 144, 255);
        $black = imagecolorexactalpha($im, 0, 0, 0,64);
        $red = imagecolorallocate($im, 224, 64, 32);
        $white = imagecolorexactalpha($im, 255, 255,255,64);

        $maxX=imagesx($im);
        $maxY=imagesy($im);
</code></pre>
<p>And here it becomes interesting:</p>
<p>I want to write 2 Lines diagonally over the image, in a good, readable size. This means I&rsquo;ll have to calculate the angle first, in which to write the text. As it happens, thats the arcustangens of the image dimensions.</p>
<pre><code>        $ratio=$maxX/$maxY;
        $mean=atan2($maxY,$maxX);
        $ang=rad2deg($mean);
</code></pre>
<p>Then I need to find out, which fontsize to select, so that its still readable. I increase the fontsize by one and look of the size of the boundingbox of the text:</p>
<pre><code>        $bbx=1;$bby=1;$fs=1;
        while ((abs(($maxX/$bbx)*($maxY/$bby))&gt;3) or (fs&gt;120)) {			
            $fs+=1;
            $BBox=imagettfbbox($fs,$ang,$fontfile,$string1);
            $bbx=$BBox[4]-$BBox[0];
            $bby=$BBox[5]-$BBox[1];
            $e=abs(($maxX/$bbx)*($maxY/$bby));
            }
</code></pre>
<p>Because I write two lines, I&rsquo;m moving the text a bit away from the diagonale</p>
<pre><code>        $px=($maxX-$bbx)/2- (1*sin(deg2rad($ang))*$fs);
        $py=($maxY-$bby)/2- (1*cos(deg2rad($ang))*$fs);
        $ts=$fs;
</code></pre>
<p>I told you, it&rsquo;s quick &lsquo;n dirty, didn&rsquo;t I? So for the second Textline I store the main variables away,
and do the position calculation again.</p>
<pre><code>        $BBox1=$BBox;
        $px1=$px;
        $py1=$py;
        $ts1=$ts;
		
        $string=&quot;to the Author: Please copy the original to your site!&quot;;
        $fs*=0.6;
        $BBox=imagettfbbox($fs,$ang,$fontfile,$string);
        $bbx=$BBox[4]-$BBox[0];
        $bby=$BBox[5]-$BBox[1];
        $px=($maxX-$bbx)/2+ (2*sin(deg2rad($ang))*$fs);
        $py=($maxY-$bby)/2+ (2*cos(deg2rad($ang))*$fs);
        $ts=$fs;
</code></pre>
<p>Now comes another funny part:</p>
<p>Because Sometimes the text is hard to read on colored Images, I wanted the background of the text come grey. I&rsquo;m trying to create a gradient of the boundingbox of the text to the outside of the image. It&rsquo;s ugly code, I dare to comment &hellip;</p>
<pre><code>        $points=array (
                        $px+$BBox[6] , $py+$BBox[7],
                        $px+$BBox[0] , $py+$BBox[1],
                        $px+$BBox[2] , $py+$BBox[3],
                        $px+$BBox[4] , $py+$BBox[5],
                        $px1+$BBox1[2],$py1+$BBox1[3],
                        $px1+$BBox1[4],$py1+$BBox1[5],
                        $px1+$BBox1[6],$py1+$BBox1[7],
                        $px1+$BBox1[0],$py1+$BBox1[1]
                );
				
        $p1dx=0*imagesx($im);$p1dy=1*imagesy($im);
        $p2dx=0*imagesx($im); $p2dy=1*imagesy($im);
        $p3dx=1*imagesx($im); $p3dy=1*imagesy($im);
        $p4dx=1*imagesx($im); $p4dy=0.5*imagesy($im);
        $p5dx=1*imagesx($im); $p5dy=0.5*imagesy($im);
        $p6dx=1*imagesx($im); $p6dy=0*imagesy($im);
        $p7dx=0*imagesx($im); $p7dy=0*imagesy($im);
        $p8dx=0*imagesx($im); $p8dy=0.5*imagesy($im);

        $AlphaGrey=imagecolorexactalpha($im,127,127,127,96);
		
        $delta=(
                abs($p1dx-$points[0])+abs($p1dy-$points[1])+
                abs($p2dx-$points[2])+abs($p2dy-$points[3])+
                abs($p3dx-$points[4])+abs($p3dy-$points[5])+
                abs($p4dx-$points[6])+abs($p4dy-$points[7])+
                abs($p5dx-$points[8])+abs($p5dy-$points[9])+
                abs($p6dx-$points[10])+abs($p6dy-$points[11])+
                abs($p7dx-$points[12])+abs($p7dy-$points[13])+
                abs($p8dx-$points[14])+abs($p8dy-$points[15])
            );
		
        $f=0.75;
        $c=0;
        while (($delta&gt;128) and ($c++ &lt; 200))
            {
            imagefilledpolygon($im,$points,8,$AlphaGrey);
			
            $points[0]=(($points[0]*$f)+((1-$f)*$p1dx));$points[1]=(($points[1]*$f)+((1-$f)*$p1dy));
            $points[2]=(($points[2]*$f)+((1-$f)*$p2dx));$points[3]=(($points[3]*$f)+((1-$f)*$p2dy));
            $points[4]=(($points[4]*$f)+((1-$f)*$p3dx));$points[5]=(($points[5]*$f)+((1-$f)*$p3dy));
            $points[6]=(($points[6]*$f)+((1-$f)*$p4dx));$points[7]=(($points[7]*$f)+((1-$f)*$p4dy));
            $points[8]=(($points[8]*$f)+((1-$f)*$p5dx));$points[9]=(($points[9]*$f)+((1-$f)*$p5dy));
            $points[10]=(($points[10]*$f)+((1-$f)*$p6dx));$points[11]=(($points[11]*$f)+((1-$f)*$p6dy));
            $points[12]=(($points[12]*$f)+((1-$f)*$p7dx));$points[13]=(($points[13]*$f)+((1-$f)*$p7dy));
            $points[14]=(($points[14]*$f)+((1-$f)*$p8dx));$points[15]=(($points[15]*$f)+((1-$f)*$p8dy));
			
            $delta=(
                    abs($p1dx-$points[0])+abs($p1dy-$points[1])+
                    abs($p2dx-$points[2])+abs($p2dy-$points[3])+
                    abs($p3dx-$points[4])+abs($p3dy-$points[5])+
                    abs($p4dx-$points[6])+abs($p4dy-$points[7])+
                    abs($p5dx-$points[8])+abs($p5dy-$points[9])+
                    abs($p6dx-$points[10])+abs($p6dy-$points[11])+
                    abs($p7dx-$points[12])+abs($p7dy-$points[13])+
                    abs($p8dx-$points[14])+abs($p8dy-$points[15])
                );
            }
</code></pre>
<p>But when that&rsquo;s ready, then we finally write the text itself. Having an positive offset in white and an negative offset in black gives an additional effect, and should make it even more readable.</p>
<pre><code>        imagefttext($im,$ts1,$ang,$px1-1,$py1-1,$white,$fontfile,$string1);
        imagefttext($im,$ts1,$ang,$px1-0,$py1-1,$white,$fontfile,$string1);
        imagefttext($im,$ts1,$ang,$px1-1,$py1-0,$white,$fontfile,$string1);
        imagefttext($im,$ts1,$ang,$px1-2,$py1-2,$white,$fontfile,$string1);
        imagefttext($im,$ts1,$ang,$px1+1,$py1+1,$black,$fontfile,$string1);
        imagefttext($im,$ts1,$ang,$px1+0,$py1+1,$black,$fontfile,$string1);
        imagefttext($im,$ts1,$ang,$px1+1,$py1+0,$black,$fontfile,$string1);
        imagefttext($im,$ts1,$ang,$px1+2,$py1+2,$black,$fontfile,$string1);
        imagefttext($im,$ts1,$ang,$px1,$py1,$blue,$fontfile,$string1);

        imagefttext($im,$ts,$ang,$px-1,$py-1,$white,$fontfile,$string);
        imagefttext($im,$ts,$ang,$px+1,$py+1,$black,$fontfile,$string);
        imagefttext($im,$ts,$ang,$px,$py,$red,$fontfile,$string);
</code></pre>
<p>Now the imagecontent is ready. We´re writing the image (PNG stays PNG).
And after that, we redirect to the same location again.</p>
<pre><code>        @mkdir($NewImgDir,0777,true);
        if ($is_png) {
            imagepng($im,$NewImgFN);
            } else {
            imagejpeg($im,$NewImgFN,50);				
            }
        imagedestroy($im);
</code></pre>
<p>But now&rsquo; the requested Image should be in its place and get directly delivered. Otherwise it&rsquo;ll be recreated again.</p>
<pre><code>        header(&quot;Location: $OriginalRequest&quot;);
	} else {
        header(&quot;Location: /img/cached/ImageTheft.png&quot;);
	}
}
?&gt;
</code></pre>
<p>This script was hacked in two days and has enough potential to get optimized, but I was in the need of an quick solution. The this is, that the cached images are more compressed and therefore also spare me some bandwidth.</p>
</div><hr /><div class="post-navs d-flex mb-3 justify-content-evenly">
  <div class="post-nav post-prev"><i class="fas fa-fw fa-chevron-left"></i>
    <a href="https://github.amboss-zustellung.space/posts/upgrading_ubuntu_to_10.04_lts/">Upgrading Ubuntu to version 10.04 LTS
</a>
  </div><div class="post-nav post-next">
    <a href="https://github.amboss-zustellung.space/posts/commerzbank_gehts_noch__63__/">Commerzbank: Gehts noch?
</a>
    <i class="fas fa-fw fa-chevron-right"></i>
  </div></div><section class="related-posts-wrapper">
    <h3>Related Posts</h3>
    <ul class="related-posts"><li><a href="https://github.amboss-zustellung.space/posts/ab18/">Ab 18 ...
</a></li><li><a href="https://github.amboss-zustellung.space/posts/about_motivation/">About_motivation
</a></li><li><a href="https://github.amboss-zustellung.space/posts/acapella_in_mannheim/">Acapella in Mannheim
</a></li><li><a href="https://github.amboss-zustellung.space/posts/aus_aktuellem_anlass/">Aus aktuellem Anlass
</a></li><li><a href="https://github.amboss-zustellung.space/posts/autobahnkollaps/">Autobahnkollaps
</a></li></ul>
  </section></div>
    </article><div class="card component row post-comments">
  <div class="card-body"></div>
</div></div>
</div><aside class="col-lg-4 sidebar d-flex">
  <div class="container">
    
    <section class="recent-posts row card component">
  <div class="card-body">
    <h2 class="card-title">Recent Posts</h2>
    <ul><li><a href="https://github.amboss-zustellung.space/posts/my-second-post/">My Second Post
</a></li><li><a href="https://github.amboss-zustellung.space/posts/my-first-post/">My First Post
</a></li><li><a href="https://github.amboss-zustellung.space/posts/monitoring_puppet_with_munin/">Monitoring_Puppet_with_Munin
</a></li><li><a href="https://github.amboss-zustellung.space/posts/keinewerbung/">Keine Werbung
</a></li><li><a href="https://github.amboss-zustellung.space/posts/facts_about_introverts/">Facts_about_Introverts
</a></li></ul>
  </div>
</section><section class="taxonomies row card component">
      <div class="card-body">
        <h2 class="card-title">
          <a href="https://github.amboss-zustellung.space/categories">Categories</a>
        </h2>
        <div><a href="https://github.amboss-zustellung.space/categories/categorie-1/" class="badge bg-primary text-white rounded post-taxonomy" title="Categorie 1">
            Categorie 1
          </a><a href="https://github.amboss-zustellung.space/categories/categorie-2/" class="badge bg-primary text-white rounded post-taxonomy" title="Categorie 2">
            Categorie 2
          </a><a href="https://github.amboss-zustellung.space/categories/overview/" class="badge bg-primary text-white rounded post-taxonomy" title="Overview">
            Overview
          </a></div>
      </div>
    </section><section class="taxonomies row card component">
      <div class="card-body">
        <h2 class="card-title">
          <a href="https://github.amboss-zustellung.space/tags">Tags</a>
        </h2>
        <div><a href="https://github.amboss-zustellung.space/tags/blog/" class="badge bg-primary text-white rounded post-taxonomy" title="blog">
            blog
          </a><a href="https://github.amboss-zustellung.space/tags/rant/" class="badge bg-primary text-white rounded post-taxonomy" title="rant">
            rant
          </a><a href="https://github.amboss-zustellung.space/tags/language/de/" class="badge bg-primary text-white rounded post-taxonomy" title="language/de">
            language/de
          </a><a href="https://github.amboss-zustellung.space/tags/fun/" class="badge bg-primary text-white rounded post-taxonomy" title="fun">
            fun
          </a><a href="https://github.amboss-zustellung.space/tags/linux/" class="badge bg-primary text-white rounded post-taxonomy" title="linux">
            linux
          </a><a href="https://github.amboss-zustellung.space/tags/video/" class="badge bg-primary text-white rounded post-taxonomy" title="Video">
            Video
          </a><a href="https://github.amboss-zustellung.space/tags/internet/" class="badge bg-primary text-white rounded post-taxonomy" title="internet">
            internet
          </a><a href="https://github.amboss-zustellung.space/tags/ipv6/" class="badge bg-primary text-white rounded post-taxonomy" title="ipv6">
            ipv6
          </a><a href="https://github.amboss-zustellung.space/tags/language/en/" class="badge bg-primary text-white rounded post-taxonomy" title="language/en">
            language/en
          </a><a href="https://github.amboss-zustellung.space/tags/zensur/" class="badge bg-primary text-white rounded post-taxonomy" title="zensur">
            zensur
          </a></div>
      </div>
    </section>
    
  </div>
</aside>
</div>
    </main><footer class="footer mt-auto py-3 text-center container"><nav class="social-links nav my-2 justify-content-center"><a class="nav-link social-link" href="mailto:info@amboss-zustellung.space" title="Email">
      <i class="fas fa-fw fa-2x fa-envelope"></i>
    </a><a class="nav-link social-link" target="_blank" href="https://github.com/jwalzer" title="GitHub" rel="noopener noreferrer">
        <i class="fa-fw fa-2x fab fa-github"></i>
      </a><a class="nav-link social-link" target="_blank" href="https://twitter.com/janwalzer" title="Twitter" rel="noopener noreferrer">
        <i class="fa-fw fa-2x fab fa-twitter"></i>
      </a></nav>
<div class="copyright mb-2">
  
</div>
<div class="powered-by mb-2">
  Powered by <a href="https://gohugo.io" target="_blank" rel="noopener noreferrer">Hugo</a> and the <a href="https://github.com/razonyang/hugo-theme-bootstrap" target="_blank" rel="noopener noreferrer">Bootstrap</a> theme.
</div></footer>
<script src="https://github.amboss-zustellung.space/js/bundle.min.425550fc2a278561fe029578aa420a6953a8c62479f57ea3cbd6b0fc8557b403.js" integrity="sha256-QlVQ/ConhWH&#43;ApV4qkIKaVOoxiR59X6jy9aw/IVXtAM=" crossorigin="anonymous" defer></script><script defer src="https://github.amboss-zustellung.space/js/viewer.min.2f6511f1e2b87cdacb7bdeedeadc1dcf2fc9f22db69f89b70fd5d91224f892a4.js" integrity="sha256-L2UR8eK4fNrLe97t6twdzy/J8i22n4m3D9XZEiT4kqQ=" crossorigin="anonymous"></script>
</body>
</html>
